#cloud-config
hostname: ${hostname}
fqdn: ${hostname}.hpc-obs.internal
manage_etc_hosts: true

package_update: true
package_upgrade: true

packages:
  - awscli
  - jq
  - munge
  - libmunge-dev
  - libmunge2
  - python3
  - python3-pip
  - curl
  - wget
  - nfs-common
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release

write_files:
  - path: /opt/hpc-obs/scripts/setup-bcm.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      
      LOG_FILE="/var/log/demo-setup/bcm-setup.log"
      mkdir -p /var/log/demo-setup
      exec > >(tee -a "$LOG_FILE") 2>&1
      
      MARKER_FILE="/opt/nvidia/bcm/.bcm-initialized"
      BCM_ISO_S3="s3://bcm10/bcm-10.0-ubuntu2404.iso"
      BCM_ISO_LOCAL="/tmp/bcm-10.0-ubuntu2404.iso"
      BCM_MOUNT="/mnt/bcm-iso"
      
      if [[ -f "$MARKER_FILE" ]]; then
          echo "BCM already initialized, skipping..."
          exit 0
      fi
      
      echo "=== Setting up NVIDIA Base Command Manager at $(date) ==="
      
      # Get AWS region from instance metadata (IMDSv2)
      TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
      AWS_REGION=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/placement/region)
      
      # Get Munge key from SSM
      echo "Retrieving Munge key from SSM..."
      MUNGE_KEY=$(aws ssm get-parameter --name "/hpc-obs/${environment}/munge-key" --with-decryption --region "$AWS_REGION" --query 'Parameter.Value' --output text)
      
      # Setup Munge (for Slurm communication)
      echo "$MUNGE_KEY" | base64 -d > /etc/munge/munge.key
      chmod 400 /etc/munge/munge.key
      chown munge:munge /etc/munge/munge.key
      systemctl enable munge
      systemctl restart munge
      
      # Create BCM directories
      mkdir -p /opt/nvidia/bcm
      mkdir -p /var/lib/bcm
      mkdir -p /etc/bcm
      mkdir -p "$BCM_MOUNT"
      
      # Download BCM ISO from S3
      echo "Downloading BCM ISO from S3..."
      aws s3 cp "$BCM_ISO_S3" "$BCM_ISO_LOCAL" --region "$AWS_REGION"
      
      if [[ ! -f "$BCM_ISO_LOCAL" ]]; then
          echo "ERROR: Failed to download BCM ISO from S3"
          exit 1
      fi
      
      echo "BCM ISO downloaded successfully: $(ls -lh $BCM_ISO_LOCAL)"
      
      # Mount the ISO
      echo "Mounting BCM ISO..."
      mount -o loop "$BCM_ISO_LOCAL" "$BCM_MOUNT"
      
      # Check ISO contents
      echo "BCM ISO contents:"
      ls -la "$BCM_MOUNT"
      
      # Run BCM installer
      echo "Running BCM installer..."
      if [[ -f "$BCM_MOUNT/install.sh" ]]; then
          cd "$BCM_MOUNT"
          bash ./install.sh --accept-license --headnode
      elif [[ -f "$BCM_MOUNT/setup.sh" ]]; then
          cd "$BCM_MOUNT"
          bash ./setup.sh --accept-license --headnode
      elif [[ -f "$BCM_MOUNT/bcm-setup" ]]; then
          cd "$BCM_MOUNT"
          ./bcm-setup --accept-license --headnode
      else
          # Look for any installer script
          echo "Looking for BCM installer..."
          find "$BCM_MOUNT" -maxdepth 2 -name "*.sh" -o -name "install*" -o -name "setup*" | head -20
          
          # Try common BCM installation patterns
          if [[ -d "$BCM_MOUNT/cm" ]]; then
              echo "Found CM directory, running CM installer..."
              cd "$BCM_MOUNT/cm"
              if [[ -f "./install.sh" ]]; then
                  bash ./install.sh
              fi
          fi
          
          if [[ -d "$BCM_MOUNT/packages" ]]; then
              echo "Found packages directory..."
              ls -la "$BCM_MOUNT/packages"
          fi
      fi
      
      # Unmount ISO after installation
      cd /
      umount "$BCM_MOUNT" || true
      
      # Configure BCM
      cat > /etc/bcm/bcm-config.yaml << EOF
      cluster:
        name: ${cluster_name}
        domain: hpc-obs.internal
      
      network:
        management_interface: eth0
        
      slurm:
        controller: ${controller_ip}
        enabled: true
        
      provisioning:
        enabled: true
        pxe_interface: eth0
      EOF
      
      # Create BCM status script
      cat > /opt/nvidia/bcm/bcm-status.sh << 'EOFSTATUS'
      #!/bin/bash
      echo "=============================================="
      echo "NVIDIA Base Command Manager - Status"
      echo "=============================================="
      echo ""
      if command -v cmsh &>/dev/null; then
          echo "BCM Installation: INSTALLED"
          cmsh -c "device; list"
      else
          echo "BCM Installation: PENDING (check /var/log/demo-setup/bcm-setup.log)"
      fi
      echo ""
      echo "Slurm Controller: ${controller_ip}"
      echo "Cluster Name: ${cluster_name}"
      echo "=============================================="
      EOFSTATUS
      chmod +x /opt/nvidia/bcm/bcm-status.sh
      
      # Enable BCM services if installed
      if systemctl list-unit-files | grep -q cmd; then
          echo "Enabling BCM services..."
          systemctl enable cmd || true
          systemctl start cmd || true
      fi
      
      # Cleanup
      rm -f "$BCM_ISO_LOCAL"
      
      mkdir -p /opt/nvidia/bcm
      touch "$MARKER_FILE"
      echo "=== BCM setup completed at $(date) ==="

  - path: /etc/systemd/system/node_exporter.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Prometheus Node Exporter
      After=network-online.target
      Wants=network-online.target
      
      [Service]
      Type=simple
      User=node_exporter
      Group=node_exporter
      ExecStart=/usr/local/bin/node_exporter \
        --web.listen-address=:9100 \
        --collector.systemd \
        --collector.processes
      Restart=always
      RestartSec=5
      
      [Install]
      WantedBy=multi-user.target

  - path: /opt/hpc-obs/scripts/init-bcm.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      
      mkdir -p /var/log/demo-setup
      exec > >(tee -a /var/log/demo-setup/bcm-init.log) 2>&1
      echo "=== BCM node initialization started at $(date) ==="
      
      # Ensure SSM agent is running (may be snap or systemd depending on AMI)
      systemctl enable amazon-ssm-agent 2>/dev/null || true
      systemctl start amazon-ssm-agent 2>/dev/null || true
      
      # Install node_exporter
      NODE_EXPORTER_VERSION="1.7.0"
      cd /tmp
      wget -q https://github.com/prometheus/node_exporter/releases/download/v$${NODE_EXPORTER_VERSION}/node_exporter-$${NODE_EXPORTER_VERSION}.linux-amd64.tar.gz
      tar xzf node_exporter-$${NODE_EXPORTER_VERSION}.linux-amd64.tar.gz
      cp node_exporter-$${NODE_EXPORTER_VERSION}.linux-amd64/node_exporter /usr/local/bin/
      
      useradd --no-create-home --shell /bin/false node_exporter || true
      chown node_exporter:node_exporter /usr/local/bin/node_exporter
      
      systemctl daemon-reload
      systemctl enable node_exporter
      systemctl start node_exporter
      
      # Run BCM setup
      /opt/hpc-obs/scripts/setup-bcm.sh
      
      echo "=== BCM node initialization completed at $(date) ==="

runcmd:
  - /opt/hpc-obs/scripts/init-bcm.sh
